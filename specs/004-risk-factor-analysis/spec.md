# Feature Specification: 组织参与与控制风险分析（Bus Factor）

**Feature Branch**: `004-risk-factor-analysis`  
**Created**: 2024-12-19  
**Status**: Draft  
**Input**: User description: "我现在要进行Bus Factor的指标计算与分析，需要使用的图结构是actor-repo图，示例图为 @2023-01.graphml ，构图使用的原始数据是gharchive的数据，如 @2023-01-01-12-filtered.json ，现在我需要你参考之前的倦怠分析与社区氛围分析来进行，计算粒度按每个项目的每个月进行计算，然后还要有计算跨月趋势公交因子的阈值设为50%，然后就是那个贡献权重尽量合理设置，以及一些不要使用硬编码设置，尽量采用动态的，所有生成的.md后缀描述文档内容全部使用中文，使用当前004分支。注意：暂时不实现 Elephant Factor（大象因子），因为当前图结构缺少用户所属组织信息的数据。"

## Clarifications

### Session 2024-12-19

- Q: 是否实现 Elephant Factor（大象因子）功能？ → A: 暂时不实现。当前图结构（actor-repo 图）缺少用户所属组织信息的数据，无法准确计算组织级别的贡献分布。Elephant Factor 功能将在未来图结构包含准确的组织信息后实现。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 计算单个项目的月度风险指标 (Priority: P1)

用户需要分析单个开源项目在特定月份的组织参与与控制风险，通过计算该月的 Bus Factor（公交因子）来评估项目对关键贡献者的依赖程度。

**Why this priority**: 这是核心功能，是后续所有分析的基础。只有先能计算单个月份的指标，才能进行时间序列分析和趋势计算。

**Independent Test**: 可以通过加载单个项目的单个月份的 actor-repo 图文件，运行分析工具，验证系统能够正确计算该月的 Bus Factor，并输出包含详细指标信息的 JSON 结果。

**Acceptance Scenarios**:

1. **Given** 存在一个项目的 actor-repo 图文件（如 `angular-angular/actor-repo/2023-01.graphml`），**When** 运行风险分析工具，**Then** 系统能够加载图文件，计算该月的 Bus Factor，并输出包含以下信息的月度指标：
   - 月份标识
   - 项目名称
   - Bus Factor 值（达到50%贡献所需的最少贡献者数量）
   - 贡献者贡献量分布
   - 总贡献量

2. **Given** 图文件中包含多个贡献者，**When** 计算 Bus Factor，**Then** 系统能够正确聚合每个贡献者的贡献量（基于边的统计信息），按贡献量降序排序，找到达到总贡献量50%所需的最少贡献者数量

---

### User Story 2 - 分析所有项目的月度风险指标时间序列 (Priority: P2)

用户需要分析所有项目在整个时间序列上的风险指标变化，为每个项目生成月度指标时间序列，以便观察项目风险的变化趋势。

**Why this priority**: 时间序列分析是评估项目健康度的关键，能够识别风险趋势和预警信号。这需要建立在用户故事1的基础上。

**Independent Test**: 可以通过运行分析工具，验证系统能够自动加载所有项目的 actor-repo 图文件，为每个项目生成完整的月度指标时间序列，并输出包含所有月份数据的 JSON 结果。

**Acceptance Scenarios**:

1. **Given** 存在多个项目的多个月份的 actor-repo 图文件（通过 `index.json` 索引），**When** 运行分析工具，**Then** 系统能够自动遍历所有项目和月份，为每个项目生成月度指标时间序列，每个时间序列包含该项目的所有可用月份的指标数据

2. **Given** 某个项目的某些月份缺少图文件，**When** 生成时间序列，**Then** 系统能够跳过缺失的月份，只包含有数据的月份，并在日志中记录缺失信息

3. **Given** 分析过程中某个项目或月份的计算失败，**When** 继续处理其他项目，**Then** 系统能够记录错误信息但继续处理剩余项目，确保部分失败不影响整体分析

---

### User Story 3 - 计算跨月趋势和综合风险评分 (Priority: P3)

用户需要基于月度指标时间序列计算跨月趋势，并生成综合风险评分，以便快速识别高风险项目。

**Why this priority**: 综合评分和趋势分析提供了更高层次的洞察，帮助用户快速识别需要关注的项目。这需要建立在用户故事2的基础上。

**Independent Test**: 可以通过运行分析工具，验证系统能够基于月度指标时间序列计算趋势指标（如 Bus Factor 的变化趋势），并生成综合风险评分。

**Acceptance Scenarios**:

1. **Given** 某个项目有至少3个月的指标数据，**When** 计算跨月趋势，**Then** 系统能够计算以下趋势指标：
   - Bus Factor 的变化趋势（上升/下降/稳定）
   - 贡献集中度的变化（是否越来越依赖少数贡献者）

2. **Given** 某个项目的月度指标时间序列，**When** 计算综合风险评分，**Then** 系统能够生成一个综合评分（0-100），综合考虑：
   - 当前 Bus Factor 值（值越小风险越高）
   - Bus Factor 的变化趋势（上升表示风险增加）

3. **Given** 某个项目只有1-2个月的数据，**When** 计算趋势和评分，**Then** 系统能够标记为数据不足，不计算趋势但可以计算当前月份的风险评分

---

### Edge Cases

- **当图文件中没有边或只有很少的边时**：系统应该能够处理空图或稀疏图的情况，返回合理的默认值（如 Bus Factor = 0 或 1）并记录警告信息

- **当所有贡献者的贡献量完全相同时**：系统应该能够正确处理这种情况，返回达到50%所需的最少贡献者数量

- **当贡献量总和为0时**：系统应该能够检测到这种情况，返回合理的默认值并记录警告信息

- **当图文件损坏或格式不正确时**：系统应该能够捕获异常，记录错误信息，跳过该文件并继续处理其他文件

- **当某个项目的所有月份都缺失时**：系统应该能够跳过该项目，不在结果中包含该项目

- **当阈值计算时出现浮点数精度问题时**：系统应该能够正确处理浮点数比较，确保准确判断是否达到50%阈值

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够从 actor-repo 图文件中加载图数据，包括节点（Actor 和 Repository）和边（包含统计信息）

- **FR-002**: 系统必须能够从图的边中动态聚合统计信息，计算每个 Actor 的总贡献量，贡献量计算应基于边的统计字段（commit_count, pr_merged, pr_opened, issue_opened 等），使用可配置的权重公式

- **FR-003**: 系统必须能够计算 Bus Factor（Contributor Absence Factor），定义为达到总贡献量50%所需的最少贡献者数量，阈值应可配置（默认50%）

- **FR-004**: 系统必须能够为每个项目的每个月生成月度风险指标，包括 Bus Factor、贡献者贡献量分布等

- **FR-007**: 系统必须能够自动遍历所有项目和月份（通过 `index.json`），为每个项目生成完整的月度指标时间序列

- **FR-008**: 系统必须能够基于月度指标时间序列计算跨月趋势，包括 Bus Factor 的变化趋势

- **FR-009**: 系统必须能够基于月度指标时间序列计算综合风险评分，综合考虑当前值和变化趋势

- **FR-010**: 系统必须能够将分析结果保存为 JSON 格式，包括月度指标时间序列、趋势分析和综合评分

- **FR-011**: 系统必须能够处理图文件缺失、损坏等异常情况，记录错误信息但继续处理其他文件

- **FR-012**: 系统必须支持断点续传，能够识别已处理的月份并跳过，支持增量分析

- **FR-013**: 系统必须使用可配置的贡献权重公式，避免硬编码，权重应基于不同类型的贡献（commits, PRs, Issues 等）动态计算

- **FR-014**: 系统必须支持配置阈值（默认50%），允许用户自定义 Bus Factor 的计算阈值

### Key Entities *(include if feature involves data)*

- **月度风险指标（MonthlyRiskMetrics）**：单个项目在单个月份的风险指标集合，包含月份、项目名称、Bus Factor、贡献者贡献量分布、总贡献量等字段

- **贡献者贡献量（ContributorContribution）**：单个贡献者的贡献量信息，包含贡献者ID、登录名、总贡献量、贡献占比等字段

- **趋势分析结果（TrendAnalysis）**：基于时间序列的趋势分析结果，包含 Bus Factor 趋势、变化方向（上升/下降/稳定）、变化幅度等字段

- **综合风险评分（RiskScore）**：基于当前值和趋势的综合评分，包含总分、风险等级（低/中/高）、各维度得分等字段

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够为每个项目的每个月正确计算 Bus Factor，计算结果的准确性可以通过手动验证示例数据得到确认

- **SC-002**: 系统能够处理至少100个项目的分析任务，每个项目至少包含12个月的指标数据，整个分析过程在合理时间内完成（不超过2小时）

- **SC-003**: 系统能够正确识别和处理至少95%的图文件，对于无法处理的文件能够记录详细的错误信息

- **SC-004**: 系统生成的月度指标时间序列包含所有可用月份的数据，缺失月份能够被正确识别和记录

- **SC-005**: 系统能够基于至少3个月的数据计算趋势分析，趋势方向（上升/下降/稳定）的判断准确率达到90%以上

- **SC-006**: 系统生成的综合风险评分能够有效区分高风险和低风险项目，评分分布合理（不出现所有项目都是同一分数的情况）

- **SC-007**: 系统输出的 JSON 结果格式正确，能够被标准 JSON 解析器正确解析，包含所有必需的字段

- **SC-008**: 系统支持断点续传功能，在中断后重新运行时能够正确跳过已处理的月份，避免重复计算

- **SC-009**: 系统使用动态配置的贡献权重公式，权重值合理（不同类型贡献的权重符合实际重要性），避免硬编码

- **SC-010**: 系统能够处理边界情况（空图、稀疏图、数据不足等），不会因为异常情况而崩溃，能够返回合理的默认值或错误信息
