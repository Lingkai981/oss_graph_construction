# 数据模型设计：时序语义图构建（002-temporal-semantic-graph）

**目标**：将 `2015-01-01-15.json` 中的 GitHub 事件数据映射为图中的节点与边，并为这些节点/边定义清晰的字段与关系约束，确保图既能表达时间顺序，又能承载语义属性。  
**范围**：仅针对单个一小时窗口文件，并在该小时内按**分钟粒度**构建多张快照图，不涉及跨文件聚合。

---

## 1. 核心实体（节点）

### 1.1 事件节点（Event）

- **来源**：JSON 行对象的顶层字段（`id`, `type`, `created_at`, `public`, `actor`, `repo`, `payload` 等）。
- **唯一标识**：
  - `event_id`：来自原始字段 `id`，全局唯一。
- **关键属性字段**（全部来自真实数据或简单派生）：
  - 基础属性：
    - `type`：事件类型（如 `PushEvent`, `CreateEvent`, `WatchEvent` 等）。
    - `created_at`：事件发生时间（原始 ISO8601 字符串，如 `2015-01-01T15:00:01Z`）。
    - `created_at_ts`：将 `created_at` 解析为时间戳的数值形式（派生属性，便于排序与比较）。
    - `public`：布尔值，来自原始字段 `public`。
    - `repo_id`：目标仓库 ID（来自 `repo.id`，用于快速索引）。
    - `actor_id`：触发事件的开发者 ID（来自 `actor.id`）。
    - `raw_type`：与 `type` 相同，可选保留原始字符串以便调试（如不需要可省略）。
    - （可选）`payload_summary`：从 `payload` 中抽取的关键信息摘要（例如 PushEvent 中的第一条 commit message 的截断文本）。
  - 语义属性（基于整小时事件与图结构计算）：
    - `importance_score`：事件在该一小时内的重要性评分（0～1），由事件类型权重和提交数量等因素计算并经 min-max 归一化得到，数值越高表示该事件在当前时间窗口中越“关键”。
- **校验规则 / 约束**：
  - 每个事件节点必须有 `event_id`、`type`、`created_at` 三个字段。
  - 如 `actor` 或 `repo` 缺失，则对应 `actor_id`/`repo_id` 可以为空，但事件节点本身仍可存在。
  - 对于同一 `event_id`，图中最多存在一个事件节点。

---

### 1.2 开发者节点（Actor / Developer）

- **来源**：每条事件中的 `actor` 字段。
- **唯一标识**：
  - `actor_id`：来自 `actor.id`。
- **关键属性字段**：
  - 基础属性：
    - `login`：来自 `actor.login`，GitHub 登录名。
    - `avatar_url`：来自 `actor.avatar_url`。
    - `url`：来自 `actor.url`。
    - （可选）`gravatar_id`：来自 `actor.gravatar_id`。
  - 语义属性（基于整小时事件与图结构计算）：
    - `influence_score`：开发者在该一小时内的影响力评分（0～1），综合考虑其参与事件的类型权重、包含提交数量以及跨仓库活动范围等因素。数值越高，表示该开发者在当前一小时的整体行为中越“关键”。
- **校验规则 / 约束**：
  - 缺失 `actor` 字段的事件不创建开发者节点。
  - 同一 `actor_id` 的开发者节点在图中只有一个，多个事件共享该节点。

---

### 1.3 仓库节点（Repository）

- **来源**：每条事件中的 `repo` 字段。
- **唯一标识**：
  - `repo_id`：来自 `repo.id`。
- **关键属性字段**：
  - 基础属性：
    - `name`：来自 `repo.name`，通常形如 `owner/repo`。
    - `url`：来自 `repo.url`。
  - 语义属性（基于整小时事件与图结构计算）：
    - `activity_score`：仓库在该一小时内（或该分钟快照中）的活跃度评分（0～1），基于指向该仓库的所有事件的重要性得分总和，并考虑参与该仓库的不同开发者数量（对数加成）。数值越高，表示该仓库在当前时间窗口内越“活跃”或“受关注”。
- **校验规则 / 约束**：
  - 缺失 `repo` 字段的事件不创建仓库节点。
  - 同一 `repo_id` 的仓库节点在图中只有一个。

---

### 1.4 提交节点（Commit）

- **来源**：针对 `PushEvent`，来自 `payload.commits` 列表中的每个元素。
- **唯一标识**：
  - `commit_sha`：来自 `commits[*].sha`。
- **关键属性字段**：
  - 基础属性：
    - `message`：来自 `commits[*].message`。
    - `author_name`：来自 `commits[*].author.name`。
    - `author_email`：来自 `commits[*].author.email`。
    - `distinct`：来自 `commits[*].distinct`（布尔值，标识该提交是否在此次 push 中为"新"）。
    - `url`：来自 `commits[*].url`。
    - （可选派生）`message_length`：提交信息长度，用于简单语义分析。
  - 语义属性（基于整小时事件与图结构计算）：
    - `significance_score`：提交在该一小时内的重要性评分（0～1），基于所属 PushEvent 的重要性得分，并考虑提交信息长度（可能反映重要程度）等因素。数值越高，表示该提交在当前时间窗口内越“关键”。
- **校验规则 / 约束**：
  - 仅当事件类型为 `PushEvent` 且 `payload.commits` 为非空列表时创建提交节点。
  - 同一 `commit_sha` 在全图中只创建一个节点；若多个 PushEvent 引用同一提交，仅通过多条边连接到相同节点。

---

## 2. 关系建模（边）

### 2.1 开发者 → 事件（ACTOR_TRIGGERED_EVENT）

- **含义**：某个开发者在某时间触发了某个 GitHub 事件。
- **起点节点类型**：开发者节点（Actor）。
- **终点节点类型**：事件节点（Event）。
- **创建条件**：
  - 事件包含有效 `actor` 字段且成功创建了对应的开发者节点。
- **关键属性字段**：
  - 基础属性：
    - `type`：固定值 `"ACTOR_TRIGGERED_EVENT"`。
    - `created_at`：复用事件的 `created_at` 字段，表示触发时间。
  - 语义属性：
    - `contribution_strength`：贡献强度评分（0～1），通常可定义为“边连接的开发者影响力 × 事件重要性评分”，用于衡量该次行为在整小时演化中的综合贡献大小。

---

### 2.2 事件 → 仓库（EVENT_TARGETS_REPOSITORY）

- **含义**：某个事件作用于某个仓库（如向该仓库推送、创建分支、发起 watch 等）。
- **起点节点类型**：事件节点（Event）。
- **终点节点类型**：仓库节点（Repository）。
- **创建条件**：
  - 事件包含有效 `repo` 字段且成功创建了对应的仓库节点。
- **关键属性字段**：
  - 基础属性：
    - `type`：固定值 `"EVENT_TARGETS_REPOSITORY"`。
    - `created_at`：复用事件的 `created_at`。
    - （可选）`event_type`：冗余记录事件类型（如 `PushEvent`），方便按边过滤。
  - 语义属性：
    - `impact_score`：该事件对该仓库的影响评分（0～1），通常定义为“事件重要性评分”，用于衡量该次行为对该仓库的影响强度。

---

### 2.3 事件 → 提交（EVENT_CONTAINS_COMMIT）

- **含义**：对于 PushEvent，表明一次 push 事件包含了哪些具体提交。
- **起点节点类型**：事件节点（Event）。
- **终点节点类型**：提交节点（Commit）。
- **创建条件**：
  - 事件类型为 `PushEvent`，并成功解析出 `payload.commits[*].sha`。
- **关键属性字段**：
  - 基础属性：
    - `type`：固定值 `"EVENT_CONTAINS_COMMIT"`。
    - `created_at`：复用事件 `created_at`。
    - （可选）`distinct`：从对应提交节点的 `distinct` 属性中冗余，便于直接在边上做过滤。
  - 语义属性：
    - `relevance_score`：该事件与该提交的关联强度评分（0～1），通常定义为“事件重要性评分 × 提交重要性评分”，用于衡量该提交在此次 PushEvent 中的相对重要性。

---

### 2.4 事件之间的时间顺序关系（可选显式边）

- **含义**：显式表达两个事件在时间上的先后顺序。
- **方案**：
  - **基础方案（必做）**：通过事件节点的 `created_at` / `created_at_ts` 属性与全局排序保证时间顺序；不强制创建事件间的显式边。
  - **增强方案（可选）**：在需要时，可为相邻事件创建 `PRECEDES` 边，例如按照全局时间排序，对每对相邻事件创建一条 `event_i -> event_{i+1}` 的边。
- **当前特性选择**：
  - 在数据模型层面**优先依赖时间属性表达顺序**，不强制要求创建 `PRECEDES` 边；如果实现阶段评估复杂度可控，可以作为可选增强特性实现。

---

## 3. 时间与排序语义

- 所有事件节点必须包含：
  - `created_at`（字符串）；
  - `created_at_ts`（时间戳数值，便于高效排序）。
- 构建图时：
  - 将所有事件按 `created_at_ts` 升序排列；
  - 再根据分钟粒度（例如 `2015-01-01T15:23`）将事件划分到对应的一分钟快照图中，即对每个分钟构建一张独立的有向图。
- 若事件缺失 `created_at` 字段：
  - 记录解析错误到日志，并跳过该事件（不创建对应节点与相关边）。

---

## 4. 错误与异常数据处理规则

- **JSON 解析错误**：
  - 对于单行解析失败的事件：记录该行号和错误原因到日志，跳过该行。
- **字段缺失**：
  - 缺失 `id` / `type` / `created_at`：视为无效事件，整条记录跳过。
  - 缺失 `actor`：不创建开发者节点与 `ACTOR_TRIGGERED_EVENT` 边，但保留事件与仓库相关结构。
  - 缺失 `repo`：不创建仓库节点与 `EVENT_TARGETS_REPOSITORY` 边，但保留事件与开发者相关结构。
  - 对于 `PushEvent` 中 `payload.commits` 缺失或为空：不创建提交节点与相关边，仍保留该事件本身。
- **重复实体**：
  - 同一 `actor_id` / `repo_id` / `commit_sha` 在全图中只创建一个节点，通过多条边连接。

---

## 5. 与 001 特性的对齐与差异

- **对齐点**：
  - 继续使用 `networkx` 及项目内已有的节点/边建模方式；
  - 输出格式中沿用 GraphML/JSON 的导出能力；
  - 日志、错误处理策略与 001 保持一致（记录并跳过异常记录）。
- **差异点**：
  - 数据源从 SQLite 数据库（GHTorrent）变为 GitHub 事件 JSON 行文件；
  - 时间维度从“按天快照”转变为“单一小时连续事件流”，更强调事件间顺序与行为链条；
  - 新增“提交节点”和“事件 → 提交”关系，粒度更细。

---

## 6. 小结

本数据模型定义了一小时时间窗口内 GitHub 行为的图表示方式：  
以事件为中心，通过开发者、仓库、提交三类实体与对应关系边，将“谁在何时对哪个仓库做了什么、包含哪些提交”编码到有向图中；  
所有节点和边上的属性都直接或间接来源于原始 JSON 数据，满足规格中对“语义属性必须基于真实数据”的要求。后续在实现时，将基于本模型设计具体的构图代码与导出格式映射。


